exports.parse = function(fname, callback) {
    require('fs').readFile(fname, 'utf8', function(err, config) {
        if (err) {
            callback(err);
            return;
        }

        var result = [];
        var lastRule = null;
        var globalModifiers = [];
        config.split('\n').forEach(function(line) {
            line = line.trim();
            if (line && line.indexOf('#') != 0) {
                if (line.indexOf('$') == 0) {
                    var parts = line.split(' ');
                    (lastRule ? lastRule.modifiers : globalModifiers).push({
                        name: parts.shift().slice(1),
                        value: parts.join(' ').trim()
                    });
                } else if (line.indexOf('=>') > -1) {
                    var operands = line.split('=>').map(function(operand) {
                        return operand.trim();
                    });
                    lastRule = {
                        pattern: createPattern(operands[0]),
                        replacement: operands[1] ? operands[1].replace(/^(?!(https?:\/\/|file:\/\/|data:))/, 'http://') : '',
                        modifiers: globalModifiers.slice(0)
                    };
                    result.push(lastRule);
                }
            }
        });
        callback(null, result);
    });
};

function createPattern(source) {
    if (source.indexOf('/') == 0 && source.lastIndexOf('/') == source.length - 1) {
        return new RegExp(source.substr(1, source.length - 2), 'i');
    } else {
        return new RegExp('^' + source.replace(/^(?!http:\/\/)/, 'http://').replace(/([\\\/^$()\[\]+*?.|])/g, '\\$1'), 'i');
    }
}