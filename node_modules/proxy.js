exports.createServer = function(rewriter) {
    rewriter = rewriter || function(url) {
        return url;
    };
    return require('http').createServer(function(serverReq, serverRes) {
        var url = rewriter(serverReq.url);
        if (!url) {
            serverRes.end();
            return;
        }
        var requestUrl = require('url').parse(url);
        httpRequest(serverReq, serverRes, requestUrl);
    });
};


function httpRequest(serverReq, serverRes, url) {
    var host = url.hostname || serverReq.headers['host'];
    var requestOptions = {
        host: host,
        port: +(url.port || host.split(':')[1] || 80),
        method: serverReq.method,
        path: url.pathname + (url.search || '') + (url.hash || ''),
        headers: serverReq.headers
    };
    var clientReq = require('http').request(requestOptions, function(clientRes) {
        serverRes.writeHead(clientRes.statusCode, clientRes.headers);
        clientRes.on('data', function(data) {
            serverRes.write(data);
        });
        clientRes.on('end', function() {
            serverRes.end();
        });
    });

    clientReq.on('error', function(err) {
        console.log('Request error: ' + err.message);
        serverRes.end();
    });

    serverReq.on('data', function(data) {
        clientReq.write(data);
    });

    serverReq.on('end', function() {
        clientReq.end();
    });
}